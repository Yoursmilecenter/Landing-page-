<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Smile Center</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="app"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBOmZxS75qIodscsge-gHYuUlb2vCvl0ZM",
            authDomain: "smile-center-7c6f5.firebaseapp.com",
            projectId: "smile-center-7c6f5",
            storageBucket: "smile-center-7c6f5.firebasestorage.app",
            messagingSenderId: "517098616907",
            appId: "1:517098616907:web:6e321d280049cd67c1b5ce"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allUsers = [];

        const admins = ['admin@smile.com'];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if (!admins.includes(currentUser.email)) {
                    window.location.href = 'index.html';
                    return;
                }
                await loadData();
            } else {
                window.location.href = 'portal-login.html';
            }
        });

        async function loadData() {
            try {
                const usersRef = collection(db, 'users');
                const snapshot = await getDocs(usersRef);
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            } catch (error) {
                console.error('Error:', error);
                render();
            }
        }

        function render() {
            const pendingUsers = allUsers.filter(u => u.status === 'pending-approval');
            const activeUsers = allUsers.filter(u => u.status === 'active');

            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div class="header-content">
                        <img src="smile-center-logo.png" alt="Smile Center" style="height: 55px;">
                        <span class="admin-badge">ADMIN</span>
                        <div style="display: flex; align-items: center; gap: 16px; margin-left: auto;">
                            <span style="color: var(--color-text-secondary); font-size: 14px;">${currentUser.email}</span>
                            <button class="logout-btn" onclick="logout()">Logout</button>
                        </div>
                    </div>
                </div>
                
                <div class="main">
                    <div class="section-header">
                        <div>
                            <h1 class="page-title">User Management</h1>
                            <p class="page-subtitle">Manage clients and approve registrations.</p>
                        </div>
                        <button class="btn-primary" onclick="openAddClientModal()">
                            <i class="fas fa-user-plus"></i> Add Client
                        </button>
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-label">Pending Approval</div>
                            <div class="stat-value">${pendingUsers.length}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Clients</div>
                            <div class="stat-value">${activeUsers.length}</div>
                        </div>
                    </div>

                    ${pendingUsers.length > 0 ? `
                        <h3 style="margin: 30px 0 20px;">Pending Registrations</h3>
                        <div class="projects-list">
                            ${pendingUsers.map(user => `
                                <div class="project-card">
                                    <div class="project-header">
                                        <div>
                                            <h3 class="project-title">${user.username}</h3>
                                            <p class="project-meta">${user.email}</p>
                                        </div>
                                        <span class="status-badge status-pending">PENDING</span>
                                    </div>
                                    <div style="display: flex; gap: 12px; margin-top: 12px;">
                                        <button class="btn-primary" onclick="approveUser('${user.id}')" style="background: var(--color-success);">
                                            ✅ Approve
                                        </button>
                                        <button class="btn-secondary" onclick="rejectUser('${user.id}')">
                                            ❌ Reject
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <h3 style="margin: 30px 0 20px;">Active Clients</h3>
                    <div class="projects-list">
                        ${activeUsers.length > 0 ? activeUsers.map(user => `
                            <div class="project-card">
                                <div class="project-header">
                                    <div>
                                        <h3 class="project-title">${user.username}</h3>
                                        <p class="project-meta">${user.email || 'No email'}</p>
                                    </div>
                                    <span class="status-badge status-completed">ACTIVE</span>
                                </div>
                            </div>
                        `).join('') : '<p style="color: var(--color-text-secondary); padding: 20px;">No active clients yet</p>'}
                    </div>
                </div>

                <div id="addClientModal" class="modal">
                    <div class="modal-content">
                        <button class="close" onclick="closeAddClient()">&times;</button>
                        <h2 class="modal-title">Add New Client</h2>
                        <form id="addClientForm" onsubmit="addClient(event)">
                            <div class="form-group">
                                <label class="form-label">Username *</label>
                                <input type="text" id="newUsername" class="form-input" placeholder="Enter username" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email *</label>
                                <input type="email" id="newEmail" class="form-input" placeholder="Enter email" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password *</label>
                                <input type="password" id="newPassword" class="form-input" placeholder="Enter password (min 6 chars)" required>
                            </div>
                            <div id="addClientStatus" class="status-msg"></div>
                            <button type="submit" class="btn-primary" style="width: 100%; padding: 14px;">Create Client</button>
                        </form>
                    </div>
                </div>
            `;
        }

        window.openAddClientModal = () => {
            document.getElementById('addClientModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closeAddClient = () => {
            document.getElementById('addClientModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            document.getElementById('addClientForm').reset();
            document.getElementById('addClientStatus').className = 'status-msg';
        };

        window.addClient = async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const password = document.getElementById('newPassword').value;
            const statusEl = document.getElementById('addClientStatus');

            try {
                // Check if username exists
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('username', '==', username));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    statusEl.textContent = '❌ Username already exists';
                    statusEl.className = 'status-msg active error';
                    return;
                }

                // Create Firebase Auth user
                const loginEmail = username + '@smile.local';
                const userCredential = await createUserWithEmailAndPassword(auth, loginEmail, password);
                
                // Store in Firestore
                await addDoc(collection(db, 'users'), {
                    uid: userCredential.user.uid,
                    username: username,
                    email: email,
                    loginEmail: loginEmail,
                    role: 'client',
                    status: 'active',
                    createdAt: Date.now()
                });

                statusEl.textContent = '✅ Client created successfully!';
                statusEl.className = 'status-msg active success';
                
                setTimeout(() => {
                    closeAddClient();
                    loadData();
                }, 1500);
            } catch (error) {
                let msg = '❌ Error creating client';
                if (error.code === 'auth/email-already-in-use') {
                    msg = '❌ Username already registered';
                } else if (error.code === 'auth/weak-password') {
                    msg = '❌ Password must be at least 6 characters';
                }
                statusEl.textContent = msg;
                statusEl.className = 'status-msg active error';
            }
        };

        window.approveUser = async (userId) => {
            try {
                await updateDoc(doc(db, 'users', userId), { status: 'active' });
                await loadData();
            } catch (error) {
                alert('Error approving user: ' + error.message);
            }
        };

        window.rejectUser = async (userId) => {
            if (confirm('Are you sure you want to reject this registration?')) {
                try {
                    await updateDoc(doc(db, 'users', userId), { status: 'rejected' });
                    await loadData();
                } catch (error) {
                    alert('Error rejecting user: ' + error.message);
                }
            }
        };

        window.logout = async () => {
            try {
                await signOut(auth);
                window.location.href = 'portal-login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
    </script>
</body>
</html>
