<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Smile Center</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        select {
            background-color: var(--color-background) !important;
            color: var(--color-text-light) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        select option {
            background-color: var(--color-card) !important;
            color: var(--color-text-light) !important;
        }
        .compact-card {
            padding: 16px !important;
            margin-bottom: 12px !important;
        }
        .compact-card .project-header {
            margin-bottom: 8px !important;
        }
        .compact-card .project-title {
            font-size: 18px !important;
        }
        .compact-card .project-description {
            font-size: 14px !important;
            margin: 8px 0 !important;
        }
        .compact-card .form-group {
            margin: 12px 0 8px 0 !important;
        }
        .compact-card select {
            padding: 6px 10px !important;
            font-size: 13px !important;
        }
        .filter-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-bar select {
            min-width: 180px;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, orderBy, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBOmZxS75qIodscsge-gHYuUlb2vCvl0ZM",
            authDomain: "smile-center-7c6f5.firebaseapp.com",
            projectId: "smile-center-7c6f5",
            storageBucket: "smile-center-7c6f5.firebasestorage.app",
            messagingSenderId: "517098616907",
            appId: "1:517098616907:web:6e321d280049cd67c1b5ce"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allProjects = [];
        let filteredProjects = [];
        
        const admins = [
            { email: 'admin@smile.com', name: 'Admin' },
        ];

        const designers = [
            { email: 'designer1@smile.com', name: 'Designer 1' },
            { email: 'designer2@smile.com', name: 'Designer 2' },
        ];

        let currentFilters = {
            status: 'all',
            designer: 'all',
            sortBy: 'date-desc'
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if (!admins.some(a => a.email === currentUser.email)) {
                    window.location.href = 'index.html';
                    return;
                }
                await loadData();
            } else {
                window.location.href = 'portal-login.html';
            }
        });

        async function loadData() {
            try {
                const projectsRef = collection(db, 'projects');
                const q = query(projectsRef, orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                allProjects = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                applyFilters();
            } catch (error) {
                console.error('Error:', error);
                render();
            }
        }

        function applyFilters() {
            filteredProjects = allProjects.filter(p => {
                if (currentFilters.status !== 'all' && p.status !== currentFilters.status) return false;
                if (currentFilters.designer !== 'all' && p.assignedDesignerEmail !== currentFilters.designer) return false;
                return true;
            });

            if (currentFilters.sortBy === 'date-asc') {
                filteredProjects.sort((a, b) => a.createdAt - b.createdAt);
            } else if (currentFilters.sortBy === 'date-desc') {
                filteredProjects.sort((a, b) => b.createdAt - a.createdAt);
            } else if (currentFilters.sortBy === 'name-asc') {
                filteredProjects.sort((a, b) => a.title.localeCompare(b.title));
            } else if (currentFilters.sortBy === 'name-desc') {
                filteredProjects.sort((a, b) => b.title.localeCompare(a.title));
            }

            render();
        }

        window.updateFilter = (type, value) => {
            currentFilters[type] = value;
            applyFilters();
        };

        function render() {
            const stats = {
                total: allProjects.length,
                pending: allProjects.filter(p => p.status === 'pending').length,
                inProgress: allProjects.filter(p => p.status === 'in-progress').length,
                completed: allProjects.filter(p => p.status === 'completed').length
            };

            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div class="header-content">
                        <img src="smile-center-logo.png" alt="Smile Center" style="height: 40px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <span class="admin-badge" style="background: rgba(239, 68, 68, 0.2); color: var(--color-error); border: 1px solid rgba(239, 68, 68, 0.3); padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">ADMIN</span>
                            <span style="color: var(--color-text-secondary); font-size: 14px;">${currentUser.email}</span>
                            <button class="logout-btn" onclick="logout()">Logout</button>
                        </div>
                    </div>
                </div>
                
                <div class="main">
                    <h1 class="page-title">Admin Panel</h1>
                    <p class="page-subtitle">Manage all patients and assign designers.</p>

                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-label">Total Patients</div>
                            <div class="stat-value">${stats.total}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Pending</div>
                            <div class="stat-value">${stats.pending}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">In Progress</div>
                            <div class="stat-value">${stats.inProgress}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Completed</div>
                            <div class="stat-value">${stats.completed}</div>
                        </div>
                    </div>

                    <div class="filter-bar">
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--color-text-secondary);">Filter by Status:</label>
                            <select onchange="updateFilter('status', this.value)">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="awaiting-client-approval">Awaiting Approval</option>
                                <option value="approved">Approved</option>
                                <option value="changes-requested">Changes Requested</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--color-text-secondary);">Filter by Designer:</label>
                            <select onchange="updateFilter('designer', this.value)">
                                <option value="all">All Designers</option>
                                <option value="null">Unassigned</option>
                                ${designers.map(d => `<option value="${d.email}">${d.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-size: 13px; color: var(--color-text-secondary);">Sort By:</label>
                            <select onchange="updateFilter('sortBy', this.value)">
                                <option value="date-desc">Date (Newest First)</option>
                                <option value="date-asc">Date (Oldest First)</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                            </select>
                        </div>
                        <div style="margin-left: auto; margin-top: 20px;">
                            <span style="font-size: 14px; color: var(--color-text-secondary);">Showing ${filteredProjects.length} of ${allProjects.length} patients</span>
                        </div>
                    </div>

                    <div class="projects-list">
                        ${filteredProjects.length > 0 ? filteredProjects.map(project => `
                            <div class="project-card compact-card">
                                <div class="project-header">
                                    <h3 class="project-title">${project.title}</h3>
                                    <span class="status-badge status-${project.status.replace('-', '')}">${project.status.toUpperCase()}</span>
                                </div>
                                <p class="project-description">${project.description}</p>
                                <div class="project-meta" style="font-size: 13px;">
                                    Client: ${project.clientEmail} â€¢ Created ${new Date(project.createdAt).toLocaleDateString()}
                                </div>
                                
                                <div class="admin-controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                                    <div class="form-group">
                                        <label for="designer-${project.id}" style="font-size: 13px;">Assign Designer:</label>
                                        <select id="designer-${project.id}" onchange="assignDesigner('${project.id}', this.value)">
                                            <option value="">Unassigned</option>
                                            ${designers.map(d => `<option value="${d.email}" ${project.assignedDesignerEmail === d.email ? 'selected' : ''}>${d.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="status-${project.id}" style="font-size: 13px;">Update Status:</label>
                                        <select id="status-${project.id}" onchange="updateStatus('${project.id}', this.value)">
                                            <option value="pending" ${project.status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="in-progress" ${project.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                            <option value="awaiting-client-approval" ${project.status === 'awaiting-client-approval' ? 'selected' : ''}>Awaiting Approval</option>
                                            <option value="approved" ${project.status === 'approved' ? 'selected' : ''}>Approved</option>
                                            <option value="changes-requested" ${project.status === 'changes-requested' ? 'selected' : ''}>Changes Requested</option>
                                            <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<div class="empty"><div class="empty-icon">ðŸ“‚</div><div class="empty-title">No Patients Found</div><p class="page-subtitle">No patients match the current filters.</p></div>'}
                    </div>
                </div>
            `;
        }

        window.assignDesigner = async (projectId, designerEmail) => {
            try {
                await updateDoc(doc(db, 'projects', projectId), {
                    assignedDesignerEmail: designerEmail || null,
                    status: designerEmail ? 'in-progress' : 'pending'
                });
                await loadData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        window.updateStatus = async (projectId, newStatus) => {
            try {
                await updateDoc(doc(db, 'projects', projectId), { status: newStatus });
                await loadData();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        window.logout = async () => {
            try {
                await signOut(auth);
                window.location.href = 'portal-login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
    </script>
</body>
</html>
