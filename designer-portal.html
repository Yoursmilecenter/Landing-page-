<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Designer Panel - Smile Center</title>
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @keyframes logoGlow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.4)); }
            50% { filter: drop-shadow(0 0 16px rgba(59, 130, 246, 0.8)); }
        }
        .header img, .header-content img {
            background: transparent !important;
            box-shadow: none !important;
            padding: 0 !important;
        }
        select, input[type="text"] {
            background-color: rgba(255, 255, 255, 0.05) !important;
            color: var(--color-text-light) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: rgba(167, 139, 250, 0.5) !important;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
        }
        select option {
            background-color: rgba(0, 0, 0, 0.98) !important;
            color: var(--color-text-light) !important;
        }
        .ultra-compact-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            overflow: hidden;
        }
        .ultra-compact-table thead {
            background: rgba(167, 139, 250, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .ultra-compact-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: var(--color-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .ultra-compact-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
        }
        .ultra-compact-table tbody tr {
            transition: all 0.2s ease;
        }
        .ultra-compact-table tbody tr:hover {
            background: rgba(167, 139, 250, 0.08);
        }
        .urgent-row {
            background: rgba(239, 68, 68, 0.1) !important;
            border-left: 3px solid #ef4444;
        }
        .vip-row {
            background: rgba(251, 191, 36, 0.1) !important;
            border-left: 3px solid #fbbf24;
        }
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-input {
            flex: 1;
            min-width: 250px;
        }
        .badge-urgent {
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-vip {
            background: #fbbf24;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .action-btn {
            padding: 5px 10px;
            font-size: 11px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin: 0 2px;
            background: #a78bfa;
            color: white;
            transition: all 0.2s ease;
        }
        .action-btn:hover {
            background: #8b5cf6;
            transform: translateY(-1px);
        }
        .action-btn.upload {
            background: #6366f1;
        }
        .action-btn.upload:hover {
            background: #4f46e5;
        }
        .action-btn.view {
            background: #10b981;
        }
        .action-btn.view:hover {
            background: #059669;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }
        .pagination button {
            padding: 6px 12px;
            background: var(--color-secondary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        .pagination button:hover:not(:disabled) {
            background: #8b5cf6;
            transform: translateY(-1px);
        }
        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, listAll, getMetadata, getBlob } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getFirestore, collection, getDocs, query, where, orderBy, updateDoc, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBOmZxS75qIodscsge-gHYuUlb2vCvl0ZM",
            authDomain: "smile-center-7c6f5.firebaseapp.com",
            projectId: "smile-center-7c6f5",
            storageBucket: "smile-center-7c6f5.firebasestorage.app",
            messagingSenderId: "517098616907",
            appId: "1:517098616907:web:6e321d280049cd67c1b5ce"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const db = getFirestore(app);

        let currentUser = null;
        let myProjects = [];
        let filteredProjects = [];
        let currentProjectForFiles = null;
        
        const designers = [
            { email: 'designer1@smile.com', name: 'Designer 1' },
            { email: 'designer2@smile.com', name: 'Designer 2' },
        ];

        let currentFilters = {
            status: 'all',
            priority: 'all',
            sortBy: 'date-desc',
            search: ''
        };

        let currentPage = 1;
        let itemsPerPage = 50;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if (!designers.some(d => d.email === currentUser.email)) {
                    window.location.href = 'index.html'; 
                    return;
                }
                await loadData();
            } else {
                window.location.href = 'portal-login.html';
            }
        });

        async function loadData() {
            try {
                const projectsRef = collection(db, 'projects');
                const q = query(
                    projectsRef, 
                    where('assignedDesignerEmail', '==', currentUser.email),
                    orderBy('createdAt', 'desc')
                );
                const snapshot = await getDocs(q);
                
                myProjects = [];
                for (const docSnap of snapshot.docs) {
                    const data = docSnap.data();
                    const files = await loadFiles(docSnap.id);
                    myProjects.push({ id: docSnap.id, ...data, files });
                }
                
                applyFilters();
            } catch (error) {
                console.error('Error:', error);
                render();
            }
        }

        async function loadFiles(projectId) {
            try {
                const filesRef = ref(storage, `projects/${projectId}`);
                const list = await listAll(filesRef);
                const files = await Promise.all(
                    list.items.map(async (item) => {
                        const url = await getDownloadURL(item);
                        const meta = await getMetadata(item);
                        return {
                            name: item.name,
                            url,
                            path: item.fullPath,
                            size: meta.size,
                            date: new Date(meta.timeCreated).toLocaleDateString()
                        };
                    })
                );
                return files;
            } catch {
                return [];
            }
        }

        function applyFilters() {
            filteredProjects = myProjects.filter(p => {
                if (currentFilters.status !== 'all' && p.status !== currentFilters.status) return false;
                if (currentFilters.priority !== 'all') {
                    if (currentFilters.priority === 'urgent' && !p.isUrgent) return false;
                    if (currentFilters.priority === 'vip' && !p.isVIP) return false;
                    if (currentFilters.priority === 'normal' && (p.isUrgent || p.isVIP)) return false;
                }
                if (currentFilters.search) {
                    const searchLower = currentFilters.search.toLowerCase();
                    return p.title.toLowerCase().includes(searchLower) || 
                           p.description.toLowerCase().includes(searchLower) ||
                           p.clientEmail.toLowerCase().includes(searchLower);
                }
                return true;
            });

            if (currentFilters.sortBy === 'date-asc') {
                filteredProjects.sort((a, b) => a.createdAt - b.createdAt);
            } else if (currentFilters.sortBy === 'date-desc') {
                filteredProjects.sort((a, b) => b.createdAt - a.createdAt);
            } else if (currentFilters.sortBy === 'name-asc') {
                filteredProjects.sort((a, b) => a.title.localeCompare(b.title));
            } else if (currentFilters.sortBy === 'name-desc') {
                filteredProjects.sort((a, b) => b.title.localeCompare(a.title));
            }

            currentPage = 1;
            render();
        }

        window.updateFilter = (type, value) => {
            currentFilters[type] = value;
            applyFilters();
        };

        window.handleSearch = (value) => {
            currentFilters.search = value;
            applyFilters();
        };

        function formatSize(bytes) {
            const thresh = 1024;
            if (Math.abs(bytes) < thresh) return bytes + ' B';
            const units = ['KB', 'MB', 'GB'];
            let u = -1;
            do {
                bytes /= thresh;
                ++u;
            } while (Math.abs(bytes) >= thresh && u < units.length - 1);
            return bytes.toFixed(1) + ' ' + units[u];
        }

        window.copyLink = (url) => {
            navigator.clipboard.writeText(url).then(() => alert('Download link copied!'));
        };

        window.forceDownload = async (path, filename) => {
            try {
                const fileRef = ref(storage, path);
                const blob = await getBlob(fileRef);
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(blobUrl);
            } catch (error) {
                console.error('Download error:', error);
                alert('Download failed: ' + error.message);
            }
        };

        function render() {
            const stats = {
                total: myProjects.length,
                pending: myProjects.filter(p => p.status === 'pending').length,
                inProgress: myProjects.filter(p => p.status === 'in-progress').length,
                completed: myProjects.filter(p => p.status === 'completed').length,
                awaiting: myProjects.filter(p => p.status === 'awaiting-client-approval').length,
                urgent: myProjects.filter(p => p.isUrgent).length
            };

            const totalPages = Math.ceil(filteredProjects.length / itemsPerPage);
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageProjects = filteredProjects.slice(startIdx, endIdx);

            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div class="header-content">
                        <img src="smile-center-logo.png" alt="Smile Center" style="height: 55px; animation: logoGlow 3s ease-in-out infinite; display: block; padding: 0; margin: 0;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <span class="admin-badge" style="background: rgba(167, 139, 250, 0.2); color: var(--color-secondary); border: 1px solid rgba(167, 139, 250, 0.3); padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">DESIGNER</span>
                            <span style="color: var(--color-text-secondary); font-size: 14px;">${currentUser.email}</span>
                            <button class="logout-btn" onclick="logout()">Logout</button>
                        </div>
                    </div>
                </div>
                
                <div class="main">
                    <h1 class="page-title">My Assigned Patients</h1>
                    

                    <div class="stats" style="grid-template-columns: repeat(6, 1fr);">
                        <div class="stat-card">
                            <div class="stat-label">Total Assigned</div>
                            <div class="stat-value">${stats.total}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Pending</div>
                            <div class="stat-value">${stats.pending}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">In Progress</div>
                            <div class="stat-value">${stats.inProgress}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Awaiting Approval</div>
                            <div class="stat-value">${stats.awaiting}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Completed</div>
                            <div class="stat-value">${stats.completed}</div>
                        </div>
                        <div class="stat-card" style="background: rgba(239, 68, 68, 0.1);">
                            <div class="stat-label">‚ö° Urgent</div>
                            <div class="stat-value">${stats.urgent}</div>
                        </div>
                    </div>

                    <div class="filter-bar">
                        <input type="text" class="search-input" placeholder="üîç Search patients..." 
                               oninput="handleSearch(this.value)" value="${currentFilters.search}">
                        <select onchange="updateFilter('status', this.value)" style="min-width: 150px;">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="awaiting-client-approval">Awaiting Approval</option>
                            <option value="approved">Approved</option>
                            <option value="changes-requested">Changes Requested</option>
                            <option value="completed">Completed</option>
                        </select>
                        <select onchange="updateFilter('priority', this.value)" style="min-width: 140px;">
                            <option value="all">All Priorities</option>
                            <option value="urgent">‚ö° Urgent Only</option>
                            <option value="vip">‚≠ê VIP Only</option>
                            <option value="normal">Normal Only</option>
                        </select>
                        <select onchange="updateFilter('sortBy', this.value)" style="min-width: 140px;">
                            <option value="date-desc">Date (Newest)</option>
                            <option value="date-asc">Date (Oldest)</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                        </select>
                        <select onchange="itemsPerPage = parseInt(this.value); applyFilters();" style="min-width: 120px;">
                            <option value="25">25 per page</option>
                            <option value="50" selected>50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                        <div style="margin-left: auto; font-size: 13px; color: var(--color-text-secondary);">
                            Showing ${startIdx + 1}-${Math.min(endIdx, filteredProjects.length)} of ${filteredProjects.length}
                        </div>
                    </div>

                    <table class="ultra-compact-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Patient Name</th>
                                <th style="width: 15%;">Status</th>
                                <th style="width: 12%;">Priority</th>
                                <th style="width: 10%;">Files</th>
                                <th style="width: 10%;">Date</th>
                                <th style="width: 23%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pageProjects.length > 0 ? pageProjects.map(project => {
                                const rowClass = project.isUrgent ? 'urgent-row' : (project.isVIP ? 'vip-row' : '');
                                const elapsed = Date.now() - project.createdAt;
                                const days = Math.floor(elapsed / (1000 * 60 * 60 * 24));
                                const hours = Math.floor((elapsed % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                const timeStr = days > 0 ? `${days}d ${hours}h ago` : `${hours}h ago`;
                                
                                return `
                                <tr class="${rowClass}">
                                    <td>
                                        <strong>${project.title}</strong>
                                        <div style="font-size: 11px; color: var(--color-text-secondary); margin-top: 2px;">${timeStr}</div>
                                        ${project.clientRemarks ? '<div style="font-size: 11px; color: #ef4444; margin-top: 2px;">‚ö†Ô∏è Changes requested</div>' : ''}
                                    </td>
                                    <td>
                                        <span class="status-badge status-${project.status.replace(/-/g, '')}">${project.status.toUpperCase().replace(/-/g, ' ')}</span>
                                    </td>
                                    <td>
                                        ${project.isUrgent ? '<span class="badge-urgent">URGENT</span>' : ''}
                                        ${project.isVIP ? '<span class="badge-vip">VIP</span>' : ''}
                                        ${!project.isUrgent && !project.isVIP ? '<span style="font-size: 11px; color: var(--color-text-secondary);">Normal</span>' : ''}
                                    </td>
                                    <td style="font-size: 12px;">${project.files.length} files</td>
                                    <td style="font-size: 11px;">${new Date(project.createdAt).toLocaleDateString()}</td>
                                    <td>
                                        <button class="action-btn upload" onclick="openUploadModal('${project.id}', '${project.title}', ${project.htmlApproved})" title="Upload Files">
                                            üì§ Upload
                                        </button>
                                        <button class="action-btn view" onclick="openFilesModal('${project.id}')" title="View Files">
                                            üìÅ Files
                                        </button>
                                    </td>
                                </tr>
                            `}).join('') : '<tr><td colspan="7" style="text-align: center; padding: 30px; color: var(--color-text-secondary);">No patients assigned</td></tr>'}
                        </tbody>
                    </table>

                    <div class="pagination">
                        <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Previous</button>
                        <span style="color: var(--color-text-secondary); font-size: 13px;">Page ${currentPage} of ${totalPages}</span>
                        <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>
                    </div>
                </div>

                <!-- Upload Modal -->
                <div id="uploadModal" class="modal">
                    <div class="modal-content">
                        <button class="close" onclick="closeUpload()">&times;</button>
                        <h2 class="modal-title">Upload Files</h2>
                        <p class="modal-subtitle">Patient: <span id="currentProjectTitle"></span></p>
                        
                        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: var(--color-secondary); margin-bottom: 10px;"></i>
                            <div style="font-size:18px; font-weight:500; margin-bottom:8px;">Drag & drop files here</div>
                            <div style="color:var(--color-text-secondary); font-size:14px;">or click to browse</div>
                        </div>
                        <input type="file" id="fileInput" multiple style="display:none;">
                        <div id="fileList" class="file-list"></div>
                        <div id="uploadStatus" class="status-msg"></div>
                        <button class="btn-primary" style="width:100%; padding:16px; margin-top:20px;" id="uploadBtn" onclick="handleUpload()">Upload Files</button>
                    </div>
                </div>

                <!-- Files Modal -->
                <div id="filesModal" class="modal">
                    <div class="modal-content large">
                        <button class="close" onclick="closeFilesModal()">&times;</button>
                        <h2 class="modal-title">Patient Files</h2>
                        <p class="modal-subtitle" id="filesPatientName"></p>
                        <div id="filesList" class="file-list"></div>
                    </div>
                </div>
            `;

            setupUploadModal();
        }

        function setupUploadModal() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', (e) => renderFileList(e.target.files));
                
                const uploadArea = document.querySelector('#uploadModal .upload-area');
                if (uploadArea) {
                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.classList.add('dragover');
                    });
                    uploadArea.addEventListener('dragleave', () => {
                        uploadArea.classList.remove('dragover');
                    });
                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('dragover');
                        fileInput.files = e.dataTransfer.files;
                        fileInput.dispatchEvent(new Event('change'));
                    });
                }
            }
        }

        function renderFileList(files) {
            const listEl = document.getElementById('fileList');
            if (!listEl) return;
            
            listEl.innerHTML = Array.from(files).map((file, index) => `
                <div class="file-list-item">
                    <span>${file.name} (${formatSize(file.size)})</span>
                    <button class="btn-icon" onclick="removeFile(${index})">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            `).join('');
        }

        window.changePage = (page) => {
            currentPage = page;
            render();
        };

        let currentProjectForUpload = null;
        let currentPatientTitle = '';

        window.openUploadModal = (projectId, projectTitle, isApproved) => {
            currentProjectForUpload = projectId;
            currentPatientTitle = projectTitle;
            document.getElementById('currentProjectTitle').textContent = projectTitle;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('uploadStatus').className = 'status-msg';
            
            document.getElementById('uploadModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closeUpload = () => {
            document.getElementById('uploadModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            document.getElementById('uploadStatus').className = 'status-msg';
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('fileInput').value = '';
        };

        window.handleUpload = async () => {
            const input = document.getElementById('fileInput');
            const files = input.files;
            const btn = document.getElementById('uploadBtn');

            if (files.length === 0) {
                showStatus('Please select at least one file.', 'error');
                return;
            }

            const hasHTML = Array.from(files).some(f => f.name.match(/\.html?$/i));
            const hasSTL = Array.from(files).some(f => f.name.match(/\.stl$/i));

            btn.disabled = true;
            btn.textContent = 'Uploading...';
            showStatus('Starting upload...', 'warning');

            try {
                // Get current project data first
                const projectSnap = await getDoc(doc(db, 'projects', currentProjectForUpload));
                const projectData = projectSnap.data();
                
                for (const file of files) {
                    const ext = file.name.substring(file.name.lastIndexOf('.'));
                    const newFileName = `${currentPatientTitle}${ext}`;
                    const storageRef = ref(storage, `projects/${currentProjectForUpload}/${newFileName}`);
                    await uploadBytesResumable(storageRef, file);
                }

                const updateData = {};
                if (hasHTML) {
                    updateData.status = 'awaiting-client-approval';
                }
                // If uploading STL and HTML already approved ‚Üí stl-ready
                if (hasSTL && projectData.htmlApproved) {
                    updateData.status = 'stl-ready';
                }
                
                if (Object.keys(updateData).length > 0) {
                    await updateDoc(doc(db, 'projects', currentProjectForUpload), updateData);
                }

                showStatus('‚úÖ Files uploaded successfully!', 'success');
                setTimeout(async () => {
                    closeUpload();
                    await loadData();
                }, 1500);
            } catch (error) {
                showStatus('‚ùå Error: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Upload Files';
            }
        };

        window.openFilesModal = async (projectId) => {
            currentProjectForFiles = myProjects.find(p => p.id === projectId);
            document.getElementById('filesPatientName').textContent = `Patient: ${currentProjectForFiles.title}`;
            document.getElementById('filesModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            renderFilesModalList();
        };

        window.closeFilesModal = () => {
            document.getElementById('filesModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            currentProjectForFiles = null;
        };

        function renderFilesModalList() {
            const listEl = document.getElementById('filesList');
            if (!currentProjectForFiles || !listEl) return;

            listEl.innerHTML = currentProjectForFiles.files.length > 0 ? currentProjectForFiles.files.map(file => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-icon">üìÑ</div>
                        <div>
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">${formatSize(file.size)} ‚Ä¢ ${file.date}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        ${file.name.match(/\.html?$/i) ? `<button class="btn-view" onclick="window.open('${file.url}', '_blank')">Preview</button>` : ''}
                        <button class="btn-download" onclick="forceDownload('${file.path}', '${file.name}')">Download</button>
                        <button class="btn-download" onclick="copyLink('${file.url}')" style="background: #10b981; color: white;">Copy Link</button>
                    </div>
                </div>
            `).join('') : '<p style="color: var(--color-text-secondary); padding: 20px; text-align: center;">No files yet</p>';
        }

        window.removeFile = (index) => {
            const dt = new DataTransfer();
            const input = document.getElementById('fileInput');
            const files = Array.from(input.files);
            files.splice(index, 1);
            files.forEach(f => dt.items.add(f));
            input.files = dt.files;
            input.dispatchEvent(new Event('change'));
        };

        function showStatus(msg, type) {
            const el = document.getElementById('uploadStatus');
            el.textContent = msg;
            el.className = `status-msg active ${type}`;
        }

        window.logout = async () => {
            try {
                await signOut(auth);
                window.location.href = 'portal-login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        };
    </script>

    <!-- WhatsApp Float Button -->
    <a href="https://wa.me/972559339666?text=Hello%20Smile%20Center!" 
       class="whatsapp-float" 
       target="_blank" 
       aria-label="Chat on WhatsApp">
        <svg viewBox="0 0 32 32" width="32" height="32">
            <path fill="currentColor" d="M16 0c-8.837 0-16 7.163-16 16 0 2.825 0.737 5.607 2.137 8.048l-2.137 7.952 7.933-2.127c2.42 1.37 5.173 2.127 8.067 2.127 8.837 0 16-7.163 16-16s-7.163-16-16-16zM16 29.467c-2.482 0-4.908-0.646-7.07-1.87l-0.507-0.292-5.247 1.408 1.417-5.263-0.315-0.528c-1.331-2.217-2.036-4.773-2.036-7.389 0-7.842 6.384-14.226 14.226-14.226s14.226 6.384 14.226 14.226c0 7.842-6.384 14.226-14.226 14.226zM22.923 19.408c-0.407-0.204-2.415-1.191-2.789-1.327s-0.646-0.204-0.917 0.204c-0.271 0.407-1.053 1.327-1.291 1.599s-0.475 0.306-0.882 0.102c-0.407-0.204-1.719-0.633-3.274-2.019-1.21-1.079-2.027-2.411-2.264-2.818s-0.024-0.626 0.179-0.829c0.183-0.183 0.407-0.475 0.611-0.713s0.271-0.407 0.407-0.679c0.136-0.271 0.068-0.509-0.034-0.713s-0.917-2.211-1.257-3.028c-0.331-0.799-0.667-0.689-0.917-0.702-0.237-0.012-0.509-0.015-0.781-0.015s-0.713 0.102-1.087 0.509c-0.373 0.407-1.428 1.395-1.428 3.402s1.462 3.946 1.666 4.218c0.204 0.271 2.825 4.416 6.879 6.132 0.962 0.407 1.713 0.651 2.299 0.833 0.967 0.307 1.847 0.264 2.543 0.16 0.776-0.116 2.415-0.987 2.755-1.939s0.34-1.771 0.238-1.939c-0.102-0.169-0.373-0.271-0.781-0.475z"/>
        </svg>
    </a>
</body>
</html>


